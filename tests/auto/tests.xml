<?xml version="1.0" encoding="ISO-8859-1"?>
<testdefinition version="1.0">
  <suite name="libqtsparql-tests">
    <set name="qsparlq-unit" description="Unit tests of libqtsparql">
      <case name="qsparqlquery" description="qsparqlquery unit tests">
        <step expected_result="0">
	  /usr/lib/libqtsparql-tests/tst_qsparqlquery
        </step>
      </case>
      <case name="qsparqlbinding" description="qsparqlbinding unit tests">
        <step expected_result="0">
      /usr/lib/libqtsparql-tests/tst_qsparqlbinding
        </step>
      </case>
      <case name="qsparqlresultrow" description="qsparqlresultrow unit tests">
        <step expected_result="0">
      /usr/lib/libqtsparql-tests/tst_qsparqlresultrow
        </step>
      </case>
      <case name="qsparql" description="qsparql unit tests">
        <step expected_result="0">
	  /usr/lib/libqtsparql-tests/tst_qsparql
        </step>
      </case>
      <environments>
        <scratchbox>true</scratchbox>
        <hardware>true</hardware>
      </environments>
    </set>
    <set name="qsparql-tracker" description="Tests for tracker plugin of qsparql">
      <pre_steps>
        <step expected_result="0">
            su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_tracker.rq;
            tracker-import /usr/share/libqtsparql-tests/testdata_tracker.ttl"
        </step>
      </pre_steps>
      <case name="tst_qsparql_tracker" description="Executing tst_qsparql_tracker">
        <step expected_result="0">
            su - user -c "/usr/lib/libqtsparql-tests/tst_qsparql_tracker"
        </step>
      </case>
      <post_steps>
        <step expected_result="0">
            su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_tracker.rq"
        </step>
      </post_steps>
      <environments>
        <scratchbox>true</scratchbox>
        <hardware>true</hardware>
      </environments>
      <get>
        <file>/home/user/.local/share/tracker/tracker-store.log</file>
      </get>
    </set>
    <set name="qsparql-tracker-direct" description="Tests for tracker direct access plugin of qsparql">
      <pre_steps>
        <step expected_result="0">
            su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_tracker_direct.rq;
            tracker-import /usr/share/libqtsparql-tests/testdata_tracker_direct.ttl"
        </step>
      </pre_steps>
      <case name="tst_qsparql_tracker_direct" description="Executing tst_qsparql_tracker_direct">
        <step expected_result="0">
            su - user -c "/usr/lib/libqtsparql-tests/tst_qsparql_tracker_direct"
        </step>
      </case>
      <post_steps>
        <step expected_result="0">
            su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_tracker_direct.rq"
        </step>
      </post_steps>
      <environments>
        <scratchbox>true</scratchbox>
        <hardware>true</hardware>
      </environments>
      <get>
        <file>/home/user/.local/share/tracker/tracker-store.log</file>
      </get>
    </set>
    <set name="qsparql-threading" description="Multithreading tests">
        <pre_steps>
            <step expected_result="0">
                su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_threading.rq;"
            </step>
        </pre_steps>
        <case name="test-tracker-queries" description="Tracker queries">
            <step expected_result="0">
                su - user -c "/usr/lib/libqtsparql-tests/tst_qsparql_threading concurrentTrackerQueries"
            </step>
        </case>
        <case name="test-tracker-direct-queries" description="Tracker direct queries">
            <step expected_result="0">
                su - user -c "/usr/lib/libqtsparql-tests/tst_qsparql_threading concurrentTrackerDirectQueries"
            </step>
        </case>
        <case name="test-tracker-direct-inserts" description="Tracker direct inserts" insignificant="true">
            <!-- this is marked as insigficant since it fails sporadically; this needs debugging! -->
            <step expected_result="0">
                su - user -c "/usr/lib/libqtsparql-tests/tst_qsparql_threading concurrentTrackerDirectInserts ||
                ( i=$? &amp;&amp; tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_threading.rq &amp;&amp; exit $i )"
            </step>
        </case>
        <post_steps>
            <step expected_result="0">
                su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_threading.rq"
            </step>
        </post_steps>
        <environments>
            <scratchbox>true</scratchbox>
            <hardware>true</hardware>
        </environments>
        <get>
            <file>/home/user/.local/share/tracker/tracker-store.log</file>
        </get>
    </set>
    <set name="qsparql-tracker-direct-sync" description="Tests for tracker direct access plugin of qsparql, sync mode">
        <pre_steps>
            <step expected_result="0">
                su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_tracker_direct.rq;
                tracker-import /usr/share/libqtsparql-tests/testdata_tracker_direct.ttl"
            </step>
        </pre_steps>
        <case name="test-query-contacts-sync" description="Executing tst_qsparql_tracker_direct_syncy">
            <step expected_result="0">
                su - user -c "/usr/lib/libqtsparql-tests/tst_qsparql_tracker_direct_sync"
            </step>
        </case>
        <post_steps>
            <step expected_result="0">
                su - user -c "tracker-sparql -u -f /usr/share/libqtsparql-tests/clean_data_tracker_direct.rq"
            </step>
        </post_steps>
        <environments>
            <scratchbox>true</scratchbox>
            <hardware>true</hardware>
        </environments>
        <get>
            <file>/home/user/.local/share/tracker/tracker-store.log</file>
        </get>
    </set>
    <set name="qsparql-tracker-direct-crashes" description="Regression tests">
      <case name="test-waitforfinished-crashes" description="Regression test">
        <step expected_result="0">
            <!-- Note: the env vars (and running this as root) should ensure that the direct connection opening fails -->
            XDG_CACHE_HOME=bogus TRACKER_SPARQL_BACKEND=direct /usr/lib/libqtsparql-tests/tst_qsparql_tracker_direct_crashes waitForFinished_crashes_when_connection_opening_fails
        </step>
      </case>
      <case name="test-syncexec-crashes" description="Regression test">
        <step expected_result="0">
            <!-- Note: the env vars (and running this as root) should ensure that the direct connection opening fails -->
            XDG_CACHE_HOME=bogus TRACKER_SPARQL_BACKEND=direct /usr/lib/libqtsparql-tests/tst_qsparql_tracker_direct_crashes syncExec_crashes_when_connection_opening_fails
        </step>
      </case>
      <case name="test-syncexec-update-crashes" description="Regression test">
        <step expected_result="0">
            <!-- Note: the env vars (and running this as root) should ensure that the direct connection opening fails -->
            XDG_CACHE_HOME=bogus TRACKER_SPARQL_BACKEND=direct /usr/lib/libqtsparql-tests/tst_qsparql_tracker_direct_crashes syncExec_update_crashes_when_connection_opening_fails
        </step>
      </case>
    </set>
  </suite>
</testdefinition>
